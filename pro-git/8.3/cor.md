# 8.3 깃 후크

## 학습목표
- 깃 후크의 역할과 사용법을 익힌다.

## 개요
- hook = 특정 action이 발생했을때 실행되는 script
- 깃 환경설정에서처럼 hook도 클라측과 서버측으로 나뉨

## 훅 설치
- 모든 훅은 `.git/hooks`에 존재
- 예시 훅을 사용하려면 리네임해야함
- 훅 스크립트를 enable하려면 hooks 디렉토리에 위치시킨다. 이름엔 확장자가 있으면 안되고 실행 가능해야 함.

## 클라측 훅
- 참고: 클라측 훅은 저장소를 클론할때 복제되지 않음

### 커밋 이벤트에 관련된 훅
- `pre-commit` 훅
   - 커밋되려는 스냅샷을 검수하기 위해 사용됨 (잊어먹은거, 테스트, 점검, 코드스타일, trailing 공백, 문서 등...)
   - 이 훅이 nonzero exit하면 커밋이 중단됨
   - `git commit --no-verify`로 이 훅을 우회 가능
- `prepare-commit-msg` 훅
   - 기본 메시지가 생성되었으나 텍스트 에디터가 열리기 전에 실행됨
   - 몇개의 인자를 취함: 커밋메시지가 들은 파일의 경로, 커밋의 유형, (amended 커밋일시) 커밋 sha-1
   - 기본 메시지가 자동으로 생성되는 커밋에 대해 유용
- `commit-msg` 훅
   - nonzero exit시 커밋이 중단됨
   - 한개의 인자를 취함: 개발자에 의해 작성된 커밋메시지가 들어있는 임시파일의 경로
   - 이 훅이 정상적으로 끝나면 커밋이 생성되는 듯
- `post-commit` 훅
   - 전체 커밋 과정이 종료되었을때 실행됨
   - 일반적으로 안내용으로 쓰임

### 이메일 이벤트에 관련된 훅
- `git am`에 의해 실행되는 훅들
- `applypatch-msg`
   - 한개의 인자를 취함: 제안된 커밋메시지를 포함하는 임시파일의 이름
   - nonzero exit시 패치를 중단함
   - 커밋메시지가 올바르게 포맷됐는지 확인하거나 커밋메시지를 normalize하는데 사용할수있음
- `pre-applypatch`
   - 패치가 적용된 "이후", 커밋이 생성되기 이전 시점에 실행됨
   - 스냅샷 점검, 테스트 실행, 작업영역 점검 등에 사용할 수 있음
   - nonzero exit시 git am이 중단되고 패치가 커밋되지 않음
- `post-applypatch`
   - 커밋이 생성된 이후에 실행되는 훅
   - post-commit 훅처럼 안내용으로 사용되는 듯

### 기타 클라측 훅
- `pre-rebase`
   - rebase를 하기전에 실행됨
   - nonzero exit으로 리베이스 중단 가능
   - 이미 푸시된 커밋의 리베이스를 disallow하는데 사용할 수 있음
- `post-rewrite`
   - 커밋을 대체하는 명령어에 의해 사용됨 (git commit --amend나 git rebase같은)
   - 인자로 어떤 명령어가 rewrite를 trigger했는지 받고, stdin으로 재작성된 것들의 리스트를 취함
   - 아래에 기술될 post-checkout 훅과 post-merge 훅과 사용상의 유사성이 있는 듯함
- `post-checkout`
   - git checkout이 성공적으로 이루어진 뒤에 실행됨
   - 작업영역을 적절하게 조성하는데 이 훅을 사용할 수 있음 (문서를 생성한다든가 큰 이진파일을 작업영역내로 들여놓는다든가)
- `post-merge`
   - 성공적인 merge 이후에 실행됨
   - 권한같이 깃이 track할수없는 작업영역의 데이터를 복원하는데 사용할 수 있음
- `pre-push`
   - push중 실행된다. 원격레퍼런스는 업데이트됐으나 실제로 객체가 전송되기 전의 시점이다.
   - 원격의 이름과 위치를 인자로 받으며 갱신될 레퍼런스의 리스트를 stdin으로 취한다.
   - 실제 푸시가 일어나기 전에 레퍼런스 업데이트를 검증할 수 있음
   - nonzero exit은 푸시를 중단함
- `pre-auto-gc`
   - 깃은 가끔씩 `git gc --auto`를 알아서 돌림
   - gc가 일어나기 전에 이 훅이 실행됨
   - 가비지 컬렉션이 일어난다는 사실을 알리거나, 가비지 컬렉션을 중단하는데 사용될 수 있음

## 서버측 훅
- 프로젝트에 policy를 집행하는데 사용할 수 있음
- 이러한 훅들은 서버에 push가 일어나기 전, 일어난 후에 실행됨
- pre 훅들은 nonzero exit해서 푸시를 중단하고 클라측에 오류메시지를 print할 수 있음
- `pre-receive`
   - stdin에서 푸쉬되고있는 레퍼런스의 리스트를 받음
   - nonzero exit시 레퍼런스중 어느것도 수락되지 않음
   - 사용예시로는 어떤 레퍼런스도 non-fast-forward가 아님을 확인하는것, ref와 file에 대해 access control하는 것이 있음
- `update`
   - 이 훅은 pusher가 업데이트하려는 모든 브랜치에 대해 한번씩 실행됨 (단, pre-receive훅은 한번만 실행됨)
   - 인자로 레퍼런스(브랜치)명, push이전에 이 레퍼런스가 가리키고 있었던 sha-1, 유저가 push하려는 sha-1
   - nonzero exit시 이 레퍼런스만 거절됨. 다른 레퍼런스는 여전히 갱신될수도 있음
- `post-receive`
   - 전체 절차가 완료된 이후에 실행됨
   - 다른 서비스를 갱신하거나 유저에게 통지하기 위해 사용할 수 있음
      - 이메일 보내기, ci서버에 통지하기, ticket-tracking 서비스 갱신하기 등
   - pre-receive훅과 같은 stdin 데이터 받음
   - 이 훅이 완료되기 전까지 클라이언트는 disconnect되지 않으므로, 시간이 오래 걸리는 작업할때는 주의

## 팁
다른 사람들도 읽을 필요가 있는 스크립트나 훅을 작성하고 있다면, 명령줄 flag의 긴 버전을 선호하라.

## 영어 공부
- enforce[인포올스]: 집행하다, 강요하다
