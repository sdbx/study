# 7.6 이력 재작성

## 학습목표
- **로컬 커밋 이력을 재편하는 방법을 확실히 숙지한다.**
- 커밋의 순서를 바꿀 수 있다.
- 커밋의 메시지를 바꾸거나 커밋 내의 파일들을 수정할 수 있다.
- 커밋들을 하나로 압축시키거나 하나의 커밋을 여러 개로 나눌 수 있다.
- 커밋을 완전히 삭제할 수 있다.

## 주의사항
1. add하기 전에 **diff --check**로 불필요한 공백이 있는지 조사하자.
2. 커밋에 만족하기 전에는 서버에 push하지 말자.

## git rebase -i
### 마지막 커밋을 변경하는 방법
- 커밋 메시지만 변경하기 => `git commit --amend`
- 커밋의 내용을 변경할수도 있음 (파일 추가/삭제/변경)
   - 추가하려는 변경사항을 만들고 add
   - 이후 commit --amend
- 이러면 변경된 커밋이 기존 커밋을 **대체**함 => SHA-1가 바뀜 => 이미 한번 push한 커밋이라면 amend하지 마라.
- 변경사항이 많다면 커밋 메시지를 변경해서 변경된 내용을 반영하는 것이 좋음
- 그러나 기존 커밋 메시지로도 적당한 수준의 변경이라면
   - editor session을 아예 생략할수도 있음
   - `git commit --amend --no-edit`

### 다수의 커밋 메시지를 변경하는 방법
- `git rebase -i`, 즉 interactive rebase를 사용해서 각각의 커밋에 대해 다양한 작업(커밋 메시지 변경, 파일 추가 등)을 할 수 있음
- 내가 수정하려는 마지막 커밋의 부모 커밋을 인자로 제공한다.
- 이 역시 리베이스 작업이므로 이미 서버에 push한 것에 대해서 하지 말도록 한다.
- 내가 제공한 인자(=가장 오래된 커밋)이 맨 위에 나온다. 위에서부터 각 커밋에서 도입한 변경사항이 replay된다.
- pick으로 되어 있는 부분을 edit으로 변경하고 저장하고 나온다.
- 명령줄에 안내된 대로 한다. commit --amend 후 rebase --continue하면 된다.

### 커밋들의 순서를 변경하는 방법
- `git rebase -i`
- 위에서부터 아래로 적용된다는 사실에 유념한다.
- 삭제하고 싶은 커밋이 있는 줄은 지운다.
- 원하는 순서대로 줄의 순서를 변경한다.
- 저장 후 나온다.

### 여러 개의 커밋들을 하나의 커밋으로 합치는 방법
- `git rebase -i`
- pick을 squash로 바꿔주면, 해당 커밋이 그 커밋의 이전 커밋에 합쳐진다.
- 저장하고 나오면 커밋 메시지를 작성할 수 있다.

### 하나의 커밋을 여러 개의 커밋으로 나누는 방법
- `git rebase -i`
- 쪼개려는 커밋을 edit으로 변경하고, 저장 후 나옴
- 쪼개려는 커밋 차례가 되면 명령줄로 이동됨
- `git reset HEAD^` => 해당 커밋을 undo하고 modified된 파일들을 unstage 상태로 만듦 (mixed reset)
- 이후 원하는대로 커밋 생성
- `git rebase --continue`

### 커밋을 삭제하는 방법
- `git rebase -i`
- 삭제하려는 커밋을 drop으로 변경하거나, 해당 줄 자체를 삭제
- 깃이 커밋 객체를 만드는 방식에 의해, 커밋을 지우거나 변경하면 이 커밋에 따르는 모든 커밋을 재작성해야함
- 만약 내가 지운 커밋에 의존하는 커밋이 있으면 merge conflict가 발생할 것임

### 리베이스 관련 메모
- 리베이스 도중 맘에 안들면 언제든지 `git rebase --abort`로 리베이스 시작 이전으로 돌아갈 수 있음
- 리베이스를 마쳤으나 맘에 들지 않으면 `git reflog`로 브랜치의 앞선 버전을 회복 가능

## filter-branch
- 많은 수의 커밋들을 재작성할 수 있는 명령어
- rebase와 마찬가지로 따라서 조심해서 사용해야 함
- 한편, 이 명령어는 현재로서는 추천되는 방식이 아니라고 함 (매뉴얼 참조) => `git-filter-repo` 스크립트의 사용이 권장됨

### 모든 커밋에서 파일을 삭제하는 방법
- `git filter-branch --tree-filter 'rm -f <file>' HEAD
- tree-filter 옵션은 명시된 명령어를 각 checkout 이후에 실행하고 그 결과를 re-commit한다.
- 일반적으로, 테스트용 브랜치에서 실험해본 후 결과가 내가 원한 것이라면 master 브랜치로 hard reset하는 것이 좋다.
- 모든 브랜치에서 filter-branch를 실행하려면 --all 옵션을 주면 된다.

### subdirectory를 새로운 프로젝트 root으로 만드는 방법
- `git filter-branch --subdirectory-filter <subdirectory> HEAD`
- subdirectory에 영향을 주지 않는 커밋은 자동적으로 삭제된다고 함

### 이메일 주소를 전역적으로 변경하는 방법
- `git filter-branch --commit-filter <command> HEAD`
- command에 내 이메일 주소만 변경하는 명령 작성 (책 참고)
- 커밋은 부모커밋의 SHA-1값을 가지고 있으므로, 이메일을 변경하게 되면 히스토리 내 모든 커밋의 SHA-1이 바뀌게 됨

## 영어 공부
- revise[리바이즈]: (의견, 계획을) 변경[수정]하다; (바로잡기 위해) 개정[조정]하다; (시험공부를 위해) 복습하다
- cardinal[칼디늘]: <형> 가장 중요한, 기본적인
- substantially[섭스탠셜리]: 상당히, 대체로
- farther[팔덜]: 더 먼
- designate[데지그네이트]: 지정하다, 지명하다
- partway[팔트웨이]: 도중까지, 어느 정도
- swath[스와스]: (낫으로) 베어낸 한 구획
- pitfall[핏폴]: (눈에 잘 안 띄는) 위험
- thoughtless[솥을러스]: 경솔한, 인정없는
- scrub[스크럽]: (솔로) 문질러 씻다, 청소하다
- batch[뱃취]: (일괄적으로 처리되는) 집단, 무리